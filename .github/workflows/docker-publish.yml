---
name: "workflow"

'on':
  push:
    branches:
      - main
    tags:
      - "*"
  pull_request:
    branches:
      - main
   
env:
  # Use docker.io for Docker Hub if empty    
  REGISTRY: docker.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}

jobs:
  integration:
    name: "CI"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout Code"
        uses: "actions/checkout@v2"

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }} 
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          context: ./
          file: ./Dockerfile
          push: true
          #tags: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.repository }}:${{github.run_id}}
          tags: ${{ github.repository }}:${{github.run_number}}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1


	    - name: AWS ECR
  		  # You may pin to the exact commit or the version.
  		  # uses: kciter/aws-ecr-action@79255b7c5aa03dbf6d7c46cff2bfd049874cd98d
  		  uses: kciter/aws-ecr-action@v4
  		  with:
  		    # The AWS access key id
  		    access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  		    # The AWS secret access key
  		    secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  		    # AWS Account ID
  		    account_id: 801193812865
  		    # A role to assume under the account_id account.
  		    assume_role: # optional, default is 
  		    # Name of your ECR repository
  		    repo: java-base-test
  		    # The AWS region
  		    region: us-west-2
  		    # Set this to true to create the repository if it does not already exist
  		    create_repo: true
  		    # Set this to true to set a policy on the repository
  		    #set_repo_policy: # optional
  		    # Set this to repository policy statement json file. only used if the set_repo_policy is set to true
  		    #repo_policy_file: # optional, default is repo-policy.json
  		    # Comma-separated string of ECR image tags
  		    tags: ${{github.run_id}} # optional, default is latest
  		    # Name of Dockerfile to use
  		    dockerfile: Dockerfile # optional, default is Dockerfile
  		    # Extra flags to pass to docker build (see docs.docker.com/engine/reference/commandline/build)
  		    #extra_build_args: # optional, default is 
  		    # Images to use as cache for the docker build (see `--cache-from` argument docs.docker.com/engine/reference/commandline/build)
  		    #cache_from: # optional, default is 
  		    # Path to Dockerfile, defaults to the working directory
  		    path: . # optional, default is .
  		    # Relative path from top-level to script to run before Docker build
  		    #prebuild_script: # optional
